<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nova Prime Connect</title>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9fafb;
    }
    .navbar {
      background-color: #22c55e;
      color: white;
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .container {
      padding: 1rem;
      max-width: 1200px;
      margin: auto;
    }
    .auth, .call-controls {
      margin-bottom: 2rem;
    }
    input, button {
      padding: 0.5rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #22c55e;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    video {
      width: 100%;
      max-height: 200px;
      border-radius: 8px;
      background: black;
    }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      border-radius: 12px;
      display: none;
      z-index: 1000;
    }
    .modal.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="navbar">Nova Prime Connect</div>
  <div class="container">
    <div class="auth">
      <input id="email" type="text" placeholder="Enter your email (jack@gmail.com)" />
      <button onclick="login()">Login</button>
    </div>
    <div class="call-controls" style="display:none">
      <p>Welcome, <span id="currentUser"></span></p>
      <input id="peerId" type="text" placeholder="Enter email to call" />
      <button onclick="callUser()">Call</button>
      <button onclick="endCall()">End</button>
      <button onclick="muteAudio()">Mute</button>
      <button onclick="shareScreen()">Share Screen</button>
      <button onclick="addCall()">Add Call</button>
    </div>
    <div class="video-grid" id="videoGrid"></div>
  </div>

  <div class="modal" id="modal">
    <p id="modalMessage"></p>
    <button onclick="closeModal()">OK</button>
  </div>

  <script>
    const allowedEmails = ['jack@gmail.com', 'nelima@gmail.com', 'judith@gmail.com'];
    let currentUser = null;
    let peer = null;
    let localStream = null;
    let currentCalls = {};

    function showModal(message) {
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    function login() {
      const email = document.getElementById('email').value.trim();
      if (!allowedEmails.includes(email)) return showModal("Email not allowed.");
      localStorage.setItem('novaUser', email);
      document.getElementById('currentUser').textContent = email;
      document.querySelector('.auth').style.display = 'none';
      document.querySelector('.call-controls').style.display = 'block';
      startPeer(email);
    }

    function startPeer(id) {
      peer = new Peer(id, { debug: 2 });

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          localStream = stream;
          addVideo(stream, 'Me');
        });

      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', remoteStream => {
          addVideo(remoteStream, call.peer);
        });
        call.on('close', () => removeVideo(call.peer));
        currentCalls[call.peer] = call;
      });

      peer.on('disconnected', () => showModal("Disconnected from PeerJS server."));
    }

    function callUser() {
      const targetId = document.getElementById('peerId').value.trim();
      if (!targetId || targetId === currentUser) return showModal("Invalid target.");
      const call = peer.call(targetId, localStream);
      call.on('stream', remoteStream => {
        addVideo(remoteStream, targetId);
      });
      call.on('close', () => {
        removeVideo(targetId);
        showModal(`${targetId} declined your call.`);
      });
      currentCalls[targetId] = call;
    }

    function endCall() {
      for (let id in currentCalls) {
        currentCalls[id].close();
        removeVideo(id);
      }
      currentCalls = {};
    }

    function muteAudio() {
      localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
    }

    function shareScreen() {
      navigator.mediaDevices.getDisplayMedia({ video: true }).then(screenStream => {
        const screenTrack = screenStream.getVideoTracks()[0];
        for (let id in currentCalls) {
          let sender = currentCalls[id].peerConnection.getSenders().find(s => s.track.kind === 'video');
          sender.replaceTrack(screenTrack);
        }
        screenTrack.onended = () => {
          localStream.getVideoTracks().forEach(track => {
            for (let id in currentCalls) {
              let sender = currentCalls[id].peerConnection.getSenders().find(s => s.track.kind === 'video');
              sender.replaceTrack(track);
            }
          });
        };
      });
    }

    function addCall() {
      callUser();
    }

    function addVideo(stream, label) {
      const videoGrid = document.getElementById('videoGrid');
      const container = document.createElement('div');
      const video = document.createElement('video');
      const tag = document.createElement('p');
      tag.textContent = label;
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      container.appendChild(tag);
      container.appendChild(video);
      container.id = `video-${label}`;
      videoGrid.appendChild(container);
    }

    function removeVideo(label) {
      const el = document.getElementById(`video-${label}`);
      if (el) el.remove();
    }

    window.onload = () => {
      const savedUser = localStorage.getItem('novaUser');
      if (savedUser && allowedEmails.includes(savedUser)) {
        document.getElementById('email').value = savedUser;
        login();
      }
    }
  </script>
</body>
</html>
